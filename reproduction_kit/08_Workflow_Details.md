# 08. ワークフロー詳細解説

このドキュメントでは、動画生成の13ステップがどのように動作するかを詳しく説明します。

## ワークフロー全体の流れ

動画生成は以下の13ステップで構成されています。各ステップは前のステップの出力を受け取り、処理を行い、次のステップへデータを渡します。

### ステップ一覧

1. **Theme Selection (テーマ選定)**
2. **Script Generation (スクリプト生成)**
3. **Title Generation (タイトル生成)**
4. **TTS Generation (音声生成)**
5. **Character Synthesis (立ち絵合成)**
6. **Background Generation (背景画像生成)**
7. **Background Animation (背景動画生成)**
8. **Subtitle Generation (字幕生成)**
9. **Video Composition (動画合成)**
10. **Audio Enhancement (効果音・BGM追加)**
11. **Illustration Insertion (挿絵挿入)**
12. **Final Encoding (最終エンコード)**
13. **YouTube Upload (YouTube投稿)** ※実装予定

---

## 各ステップの詳細

### 1. Theme Selection (テーマ選定)

**目的**: 動画で扱うテーマ（話題）を決定します。

**処理内容**:
- LLM（Gemini/GPT-4）に対して、トレンドやユーザー設定に基づいたテーマ候補を生成させます。
- 複数の候補からスコアリングして最適なテーマを選びます。

**出力**:
- 選定されたテーマ（例: 「宇宙の不思議について」）
- 動画の目標尺（例: 5分）

---

### 2. Script Generation (スクリプト生成)

**目的**: テーマに基づいて、キャラクター同士の会話台本を生成します。

**処理内容**:
- 霊夢と魔理沙（または他のキャラクター）の掛け合い形式で台本を作成します。
- 各セリフに話者情報、感情、推定時間などのメタデータを付与します。

**出力**:
- 構造化されたスクリプトデータ（JSON形式）
- プレーンテキスト版の台本

---

### 3. Title Generation (タイトル生成)

**目的**: YouTubeでクリック率（CTR）が高くなるようなタイトルを生成します。

**処理内容**:
- スクリプトの内容を分析し、魅力的なタイトル候補を複数生成します。
- SEO最適化やキーワード含有率を考慮します。

**出力**:
- 選定されたタイトル（例: 「【ゆっくり解説】宇宙の謎に迫る！驚きの事実10選」）

---

### 4. TTS Generation (音声生成)

**目的**: 台本を音声データに変換します。

**処理内容**:
- AIVIS Speech API等を使用して、各セリフを音声ファイルに変換します。
- 各セグメントごとにタイムスタンプ（どの単語が何秒に発音されるか）を取得します。
- 全セグメントを結合して一つの音声ファイルにします。

**出力**:
- 結合された音声ファイル（WAV形式）
- タイムスタンプ情報（JSON形式）

---

### 5. Character Synthesis (立ち絵合成)

**目的**: 音声に合わせて口パク（リップシンク）する立ち絵動画を生成します。

**処理内容**:
- タイムスタンプ情報を使って、発話中は口を動かし、無音時は閉じるアニメーションを作成します。
- 感情に応じて表情を変化させます。
- 透明背景のMP4動画として出力します。

**出力**:
- 立ち絵アニメーション動画（透明背景MP4）

---

### 6. Background Generation (背景画像生成)

**目的**: 台本の内容に合った背景画像を生成します。

**処理内容**:
- スクリプトの各シーンを分析し、適切な背景画像のプロンプトを作成します。
- 画像生成AI（DALL-E 3/Stable Diffusion/Gemini）で画像を生成します。

**出力**:
- 背景画像ファイル群（PNG形式）

---

### 7. Background Animation (背景動画生成)

**目的**: 静止画の背景に動きを付けて動画化します。

**処理内容**:
- Ken Burnsエフェクト（ズームやパン）を適用します。
- 音声の長さに合わせて動画の尺を調整します。

**出力**:
- 背景動画ファイル（MP4形式）

---

### 8. Subtitle Generation (字幕生成)

**目的**: 音声に同期した字幕を生成します。

**処理内容**:
- タイムスタンプ情報を使って、各セリフの表示タイミングを決定します。
- 話者ごとに色やスタイルを変えた字幕を作成します。
- ASS（Advanced SubStation Alpha）形式で出力します。

**出力**:
- 字幕ファイル（ASS形式）

---

### 9. Video Composition (動画合成)

**目的**: 背景、立ち絵、音声、字幕を一つの動画に合成します。

**処理内容**:
- FFmpegを使用して、背景動画の上に立ち絵動画を重ね、字幕を焼き込みます。
- 音声トラックを追加します。

**出力**:
- 基本合成済み動画（MP4形式）

---

### 10. Audio Enhancement (効果音・BGM追加)

**目的**: 効果音やBGMを追加して動画を豊かにします。

**処理内容**:
- 適切なタイミングで効果音（SE）を挿入します。
- BGMを追加し、音量バランスを調整します。
- LUFS正規化で音量を統一します。

**出力**:
- 効果音・BGM追加済み動画（MP4形式）

---

### 11. Illustration Insertion (挿絵挿入)

**目的**: 話題が変わるポイントで挿絵を挿入します。

**処理内容**:
- スクリプトを分析して話題転換点を検出します。
- その場面に合った挿絵を生成します。
- 動画に挿絵を挿入します。

**出力**:
- 挿絵挿入済み動画（MP4形式）

---

### 12. Final Encoding (最終エンコード)

**目的**: YouTube等の配信プラットフォームに最適化された最終動画を生成します。

**処理内容**:
- ビットレート、解像度、コーデックを最適化します。
- ファイルサイズと品質のバランスを調整します。

**出力**:
- 配信用最終動画ファイル（MP4形式）

---

### 13. YouTube Upload (YouTube投稿) ※実装予定

**目的**: 完成した動画をYouTubeに自動投稿します。

**処理内容**:
- YouTube Data APIを使用して動画をアップロードします。
- タイトル、説明文、タグなどのメタデータを設定します。

**出力**:
- YouTube動画ID、動画URL

---

## データの流れ

各ステップは以下のようにデータを受け渡します：

```
Theme → Script → Title
              ↓
         TTS (Audio + Timestamps)
              ↓
    ┌─────────┴─────────┐
Character Animation   Background Images
              ↓              ↓
              └──→ Background Video
                      ↓
              ┌───────┴───────┐
          Subtitles      Video Composition
                      ↓
              Audio Enhancement
                      ↓
              Illustration Insertion
                      ↓
              Final Encoding
                      ↓
              YouTube Upload
```

データは**PostgreSQL（メタデータ/状態管理）**と**ファイルシステム（音声・画像・動画など大容量ファイル）**の両方で管理され、各ステップは前のステップの出力を参照して処理を行います。

> 補足（RemotionとFFmpegの役割）:
> - Remotion: タイムライン・レイアウト・字幕・合成の中心（「動画編集の設計図」）
> - FFmpeg: 素材整形/音声ミックス/最終エンコード（「素材の職人」）。Remotionの出力も内部的にFFmpegに依存するケースがあります。
